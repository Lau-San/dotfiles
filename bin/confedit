#!/bin/env bash

source "colors"

conf_path="$1"

git_dir="$HOME/.dotfiles"
work_tree="$HOME"

git_cmd="git --git-dir=$git_dir --work-tree=$work_tree"
lazygit_cmd="lazygit --git-dir=$git_dir --work-tree=$work_tree"

success() {
	notif "Configuration update" "$1"
	echo -e "${green}$1${default}"
}

error() {
	notif "Something went wrong" "$1"
	echo "${red}$1${default}"
	exit 1
}

notif() {
	notify-send --app-name=Dotfiles "$1" "$2"
}

edit_config() {
    if [[ -d "$conf_path" ]]; then
        cd "$conf_path" || error "The path $1 is not a directory"
        nvim
    else
        nvim "$conf_path"
    fi
}

commit_changes() {
    while true; do
        echo "How do you want to proceed?"
        echo -e "${blue}[a]${default} Automatically stage, commit and push ALL changes"
        echo -e "${blue}[m]${default} Manually manage repo with Lazygit"
        echo -e "${blue}[q]${default} Leave changes unstaged and exit"
        echo -en "\nSelect what you want to do: "
        read -r res

        case "${res,,}" in
            a)
                $git_cmd add -u &&
                    $git_cmd commit -m "Update $(date +"%Y-%m-%d %H:%M")" && $git_cmd push &&
                    success "All your configuration changes have been automatically pushed"
                break
                ;;
            m)
                $lazygit_cmd
                break
                ;;
            q)
                break
                ;;
            *)
                echo "Please select a valid option"
                continue
        esac
    done
}

edit_config "$@"
commit_changes
