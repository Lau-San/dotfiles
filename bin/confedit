#!/bin/env bash

conf_path="$1"

git_dir="$HOME/.dotfiles"
work_tree="$HOME"

git_cmd="git --git-dir=$git_dir --work-tree=$work_tree"
lazygit_cmd="lazygit --git-dir=$git_dir --work-tree=$work_tree"

notif() {
	notify-send --app-name=Dotfiles "$1" "$2"
}

success() {
	notif "Configuration update" "$1"
	echo "$1"
}

error() {
	notif "Something went wrong" "$1"
	echo "Something went wrong."
	echo "$1"
	exit
}

if [[ -d "$conf_path" ]]; then
	cd "$conf_path" || error "The path $1 is not a directory"
	nvim
else
	nvim "$conf_path"
fi

while true; do
    echo "How do you want to proceed?"
    echo "[a] Automatically stage, commit and push ALL changes"
    echo "[m] Manually manage repo with Lazygit"
    echo "[q] Leave changes unstaged and exit"
    echo -en "\nSelect what you want to do: "
    read -r res

    case "${res,,}" in
        a)
            $git_cmd add -u &&
                $git_cmd commit -m "Update $(date +"%Y-%m-%d %H:%M")" && $git_cmd push &&
                success "All your configuration changes have been automatically pushed"
            break
            ;;
        m)
            $lazygit_cmd
            break
            ;;
        q)
            break
            ;;
        *)
            echo "Please select a valid option"
            continue
    esac
done


